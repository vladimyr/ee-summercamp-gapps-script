// *************************************************************
// *  Do NOT edit this file inside Google apps script editor!  *
// *  https://github.com/vladimyr/ee-summercamp-gapps-script   *
// *************************************************************

/* eslint-disable no-unused-vars */
/* global Environment, PropertiesService, UrlFetchApp, Utilities */

var props = PropertiesService.getScriptProperties();
var reArchive = /\.zip$|\.rar$/;

function env(name) {
  return Environment[name] || props.getProperty(name);
}

function githubUrl() {
  var args = [].slice.call(arguments, 0);
  args.unshift('https://api.github.com');
  args = args.map(function (arg) {
    return arg.replace(/^\/+|\/+$/g, '');
  });
  return args.join('/');
}

function githubHeaders(githubToken) {
  var authorization = Utilities.formatString('token %s', githubToken);
  return {
    authorization: authorization,
    accept: 'application/vnd.github.v3+json',
    'user-agent': 'https://github.com/vladimyr/ee-summercamp-gapps-script'
  };
}

function githubFetch(url, githubToken) {
  var headers = githubHeaders(githubToken);
  var resp = UrlFetchApp.fetch(url, { headers: headers });
  return JSON.parse(resp.getContentText());
}

function getUserRepos(username, githubToken) {
  var url = githubUrl('users', username, 'repos');
  return githubFetch(url, githubToken);
}

function getRepoContents(username, repo, githubToken) {
  var url = githubUrl('repos', username, repo, 'contents');
  return githubFetch(url, githubToken);
}

function isArchive(item) {
  return reArchive.test(item.name.trim());
}

var RepoStatus = {
  Found: 'REPO_FOUND',
  Invalid: 'REPO_INVALID',
  NotFound: 'REPO_NOT_FOUND'
};

/**
 * Check if user has target repo (e.g. 'ee-summercamp-2019')
 * @param {string} username Github username
 * @returns {string} result
 * @customfunction
 */
function checkGithub(username) {
  if (!username) return;
  if (username.map) {
    return username.map(checkGithub);
  }
  var githubToken = env('GITHUB_API_TOKEN');
  var repoPattern = Utilities.formatString('^%s$', env('GITHUB_REPO_PATTERN'));
  var reRepoName = new RegExp(repoPattern, 'i');
  var repos = getUserRepos(username, githubToken);
  var match = repos.find(function (repo) {
    return reRepoName.test(repo.name.trim());
  });
  if (!match) return RepoStatus.NotFound;
  try {
    var contents = getRepoContents(username, match.name, githubToken);
    if (contents.some(isArchive)) return RepoStatus.Invalid;
  } catch (err) {
    return RepoStatus.Invalid;
  }
  return RepoStatus.Found;
}
